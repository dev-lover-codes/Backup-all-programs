{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the Emoji Tic-Tac-Toe Arena.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "username": {
          "type": "string",
          "description": "The user's username."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "selectedEmoji": {
          "type": "string",
          "description": "The emoji selected by the user to represent their side (X)."
        },
        "currentStage": {
          "type": "number",
          "description": "The current stage the user is on (1-100)."
        }
      },
      "required": [
        "id",
        "username",
        "email",
        "selectedEmoji",
        "currentStage"
      ]
    },
    "Game": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Game",
      "type": "object",
      "description": "Represents a single game of Emoji Tic-Tac-Toe.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the game."
        },
        "player1Id": {
          "type": "string",
          "description": "Reference to User playing as Player 1. (Relationship: User 1:N Game)"
        },
        "player2Id": {
          "type": "string",
          "description": "Reference to User playing as Player 2, or 'AI' if against the computer. (Relationship: User 1:N Game)"
        },
        "gameLevel": {
          "type": "string",
          "description": "The difficulty level of the game ('Easy', 'Normal', 'Impossible Winning')."
        },
        "gameState": {
          "type": "string",
          "description": "The current state of the game board, represented as a string or array."
        },
        "winnerId": {
          "type": "string",
          "description": "Reference to the winning User's ID, or null if it's a draw. (Relationship: User 1:N Game)"
        },
        "stage": {
          "type": "number",
          "description": "The stage number this game was played at (1-100)."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the game was played.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "player1Id",
        "player2Id",
        "gameLevel",
        "gameState",
        "winnerId",
        "stage",
        "timestamp"
      ]
    },
    "MatchmakingRequest": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Matchmaking Request",
      "type": "object",
      "description": "A request from a user to be placed in the matchmaking queue.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The ID of the user looking for a match."
        },
        "timestamp": {
          "type": "string",
          "description": "The server timestamp when the request was created.",
          "format": "date-time"
        }
      },
      "required": ["userId", "timestamp"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information. Path-based ownership ensures only the user can modify their own profile.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user, matching the Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/games/{gameId}",
        "definition": {
          "entityName": "Game",
          "schema": {
            "$ref": "#/backend/entities/Game"
          },
          "description": "Stores game data, including player IDs, game state, and winner. Authorization is based on player1Id and player2Id, which are used in security rules to ensure only participating users can access the game data.",
          "params": [
            {
              "name": "gameId",
              "description": "The unique ID of the game."
            }
          ]
        }
      },
      {
        "path": "/matchmakingQueue/{requestId}",
        "definition": {
            "entityName": "MatchmakingRequest",
            "schema": {
                "$ref": "#/backend/entities/MatchmakingRequest"
            },
            "description": "A queue for players waiting to be matched for an online game. Security rules should ensure that users can only create requests for themselves and delete their own requests.",
            "params": [
                {
                    "name": "requestId",
                    "description": "The unique ID of the matchmaking request, often the user's ID."
                }
            ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to ensure authorization independence, clarity, and scalability for the Emoji Tic-Tac-Toe Arena application. It leverages path-based ownership for user data and segregates game data to simplify security rules and enable efficient querying. A new `matchmakingQueue` collection has been added to handle online player matching. Key authorization contexts are denormalized to avoid using `get()` in security rules.\n\n*   **User Data:** User profiles are stored under `/users/{userId}`. This path-based ownership simplifies securing user-specific data.\n*   **Game Data:** Games are stored within the `/games/{gameId}` collection. Access control is managed through the `player1Id` and `player2Id` fields within the `Game` document. These IDs link to the user documents, ensuring that only the participating players have access to game details. Additionally, the `stage` is stored at the Game level, enabling efficient querying of games by their progression stage. There is no hierarchy between `users` and `games`. Security rules should validate that `player1Id` or `player2Id` matches `request.auth.uid`.\n*  **Matchmaking Queue**: The `/matchmakingQueue/{requestId}` collection holds documents for players waiting for an opponent. This allows a matchmaking function to query for available players and create a game. Security rules will ensure users can only add themselves to the queue and can't see or interfere with other requests.\n\nThis design adheres to the core principles of Authorization Independence, DBAC (Database Authenticated Control), and QAPs (Queries are not Filters). Authorization Independence is achieved by denormalizing relevant user IDs into the game documents. DBAC is maintained by relying solely on `request.auth.uid` for authorization, without custom claims. QAPs are supported by structuring the data to facilitate secure and efficient querying, such as listing games for a specific user or stage without exposing unauthorized data."
  }
}
